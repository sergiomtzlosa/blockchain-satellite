FROM rust:1.38.0 AS build
WORKDIR /usr/src

RUN rustup target add x86_64-unknown-linux-musl

WORKDIR /usr/src/url-shortener
COPY Cargo.toml Cargo.lock ./

RUN mkdir -p /blockchain_src

WORKDIR /blockchain_src

COPY ./src /blockchain_src/src

COPY ./.env-docker /blockchain_src/

COPY ./.env /blockchain_src/

COPY ./Cargo.toml ./Cargo.lock /blockchain_src/

RUN cargo build --release

FROM scratch
COPY --from=build /blockchain_src .
USER 1000
CMD ["./blockchain-rust docker"]
